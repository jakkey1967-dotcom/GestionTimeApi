    public async Task<List<string>> SuggestTagsAsync(string? term, int limit, CancellationToken ct = default)
    {
        // 🆕 MODIFICADO: Buscar tags en ParteTags (many-to-many con PartesDeTrabajo)
        // Extraer todos los tags desde la relación ParteTag
        var query = _db.PartesDeTrabajo
            .Where(p => p.ParteTags.Any())
            .SelectMany(p => p.ParteTags.Select(pt => pt.Nombre))
            .AsQueryable();
        
        // Agrupar por nombre y contar frecuencia
        var tagFrequencyQuery = query
            .GroupBy(tagName => tagName.ToLower())
            .Select(g => new { TagName = g.Key, Count = g.Count() });
        
        // Filtrar por término si se proporciona
        if (!string.IsNullOrWhiteSpace(term))
        {
            var termLower = term.ToLower();
            tagFrequencyQuery = tagFrequencyQuery.Where(t => t.TagName.Contains(termLower));
        }
        
        // Ejecutar query, ordenar por frecuencia y tomar top N
        var results = await tagFrequencyQuery
            .OrderByDescending(t => t.Count)
            .Take(limit)
            .ToListAsync(ct);
        
        // Capitalizar primera letra para consistencia visual
        return results
            .Select(t => CapitalizeFirst(t.TagName))
            .ToList();
    }
    
    /// <summary>Capitaliza la primera letra de un string.</summary>
    private static string CapitalizeFirst(string text)
    {
        if (string.IsNullOrEmpty(text)) return text;
        if (text.Length == 1) return text.ToUpper();
        return char.ToUpper(text[0]) + text.Substring(1);
    }
