# GestionTime API - Documentación del Proyecto

## ?? Resumen Ejecutivo

**GestionTime** es una API REST para la gestión de partes de trabajo (time tracking) con sistema de autenticación JWT, multi-usuario y control de roles.

---

## ??? Arquitectura

### Capas del Sistema

```
???????????????????????????????????????????????????????????????
?                    GestionTime.Api                          ?
?  ??????????????? ??????????????? ???????????????????????   ?
?  ? Controllers ? ?  Security   ? ?     Contracts       ?   ?
?  ?             ? ? JWT/Refresh ? ?   (DTOs/Requests)   ?   ?
?  ??????????????? ??????????????? ???????????????????????   ?
?  ???????????????????????????????????????????????????????   ?
?  ?                    Logging                          ?   ?
?  ?  Serilog + Archivos separados (info/error)          ?   ?
?  ???????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????
?                 GestionTime.Application                     ?
?              (Lógica de negocio - futuro)                   ?
???????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????
?                    GestionTime.Domain                       ?
?  ???????????????????????  ???????????????????????????????  ?
?  ?   Auth Entities     ?  ?      Work Entities          ?  ?
?  ? User, Role, Token   ?  ? ParteDeTrabajo, Cliente...  ?  ?
?  ???????????????????????  ???????????????????????????????  ?
???????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????
?                GestionTime.Infrastructure                   ?
?  ???????????????????????????????????????????????????????   ?
?  ?           GestionTimeDbContext (EF Core)            ?   ?
?  ?                   PostgreSQL 9.4+                    ?   ?
?  ???????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
```

### Stack Tecnológico

| Componente | Tecnología | Versión |
|------------|------------|---------|
| Framework | .NET | 10.0 |
| Base de datos | PostgreSQL | 9.4+ |
| ORM | Entity Framework Core | 10.0.1 |
| Autenticación | JWT Bearer | Cookies HttpOnly |
| Password Hashing | BCrypt.Net-Next | 4.0.3 |
| Logging | Serilog | 9.0.0 |
| API Docs | Swagger/OpenAPI | 10.0.1 |

---

## ?? Documentación

| Documento | Descripción |
|-----------|-------------|
| [PROJECT_OVERVIEW.md](./PROJECT_OVERVIEW.md) | Este documento - Visión general |
| [LOGGING.md](./LOGGING.md) | Sistema de logging con Serilog |
| [ESTADOS.md](./ESTADOS.md) | Estados de partes de trabajo |

---

## ?? Sistema de Estados

Los partes de trabajo usan estados numéricos:

| Valor | Nombre | Descripción |
|-------|--------|-------------|
| `0` | Abierto | En progreso, editable |
| `1` | Pausado | Detenido temporalmente |
| `2` | Cerrado | Completado |
| `3` | Enviado | Sincronizado externamente |
| `9` | Anulado | Cancelado |

> ?? Ver documentación completa: [ESTADOS.md](./ESTADOS.md)

---

## ?? Sistema de Logging

### Archivos de Log

| Archivo | Contenido | Activación |
|---------|-----------|------------|
| `logs/gestiontime.log` | Information, Warning | Siempre activo |
| `logs/gestiontimeerror.log` | Debug, Error, Critical | Configurable |

> ?? Ver documentación completa: [LOGGING.md](./LOGGING.md)

---

## ?? Sistema de Autenticación

### Flujo de Autenticación

```
????????????     POST /login      ????????????
?  Cliente ? ???????????????????  ?   API    ?
?          ?  {email, password}   ?          ?
????????????                      ????????????
                                       ?
                                       ?
                              ??????????????????
                              ? Validar creds  ?
                              ? BCrypt.Verify  ?
                              ??????????????????
                                       ?
                                       ?
                              ??????????????????
                              ? Generar JWT    ?
                              ? + RefreshToken ?
                              ??????????????????
                                       ?
                                       ?
????????????   Set-Cookie (HttpOnly)  ????????????
?  Cliente ? ???????????????????????? ?   API    ?
?          ?  access_token (15min)    ?          ?
?          ?  refresh_token (14d)     ?          ?
????????????                          ????????????
```

### Tokens

| Token | Duración | Almacenamiento | Uso |
|-------|----------|----------------|-----|
| Access Token | 15 minutos | Cookie `access_token` | Autenticación |
| Refresh Token | 14 días | Cookie `refresh_token` | Renovar access |

---

## ?? Modelo de Datos

### Diagrama ER

```
???????????????       ???????????????       ???????????????
?    users    ?       ? user_roles  ?       ?    roles    ?
???????????????       ???????????????       ???????????????
? id (PK)     ????    ? user_id(FK) ?    ???? id (PK)     ?
? email       ?  ?????? role_id(FK) ??????  ? name        ?
? password_h  ?       ???????????????       ???????????????
? full_name   ?
? enabled     ?       ????????????????????
???????????????       ? refresh_tokens   ?
       ?              ????????????????????
       ???????????????? id (PK)          ?
                      ? user_id (FK)     ?
                      ? token_hash       ?
                      ? expires_at       ?
                      ? revoked_at       ?
                      ????????????????????

???????????????  ???????????????  ???????????????
?   cliente   ?  ?    grupo    ?  ?    tipo     ?
???????????????  ???????????????  ???????????????
? id (PK)     ?  ? id_grupo(PK)?  ? id_tipo(PK) ?
? nombre      ?  ? nombre      ?  ? nombre      ?
? nombre_com  ?  ? descripcion ?  ? descripcion ?
? provincia   ?  ???????????????  ???????????????
? ...         ?         ?                ?
???????????????         ?                ?
       ?                ?                ?
       ?                ?                ?
?????????????????????????????????????????????????
?              partesdetrabajo                  ?
?????????????????????????????????????????????????
? id (PK)                                       ?
? fecha_trabajo, hora_inicio, hora_fin          ?
? id_cliente (FK), tienda                       ?
? id_grupo (FK), id_tipo (FK)                   ?
? accion, ticket                                ?
? estado (int: 0,1,2,3,9)                       ?
? id_usuario (FK) ? users                       ?
? created_at, updated_at                        ?
?????????????????????????????????????????????????
```

### Roles del Sistema

| Rol | Descripción | Permisos |
|-----|-------------|----------|
| `ADMIN` | Administrador | Gestión usuarios, acceso total |
| `USER` | Usuario estándar | CRUD partes propios, catálogos |

---

## ?? API Endpoints

### Autenticación (`/api/v1/auth`)

| Método | Endpoint | Auth | Descripción |
|--------|----------|------|-------------|
| `POST` | `/login` | ? | Iniciar sesión |
| `POST` | `/refresh` | ? | Renovar tokens |
| `POST` | `/logout` | ? | Cerrar sesión |
| `GET` | `/me` | ? | Usuario actual |

### Partes de Trabajo (`/api/v1/partes`)

| Método | Endpoint | Auth | Descripción |
|--------|----------|------|-------------|
| `GET` | `/` | ? | Listar partes (filtros: fecha, q, estado) |
| `GET` | `/estados` | ? | Listar estados disponibles |
| `POST` | `/` | ? | Crear parte |
| `PUT` | `/{id}` | ? | Actualizar parte |
| `POST` | `/{id}/pausar` | ? | Pausar parte |
| `POST` | `/{id}/reanudar` | ? | Reanudar parte pausado |
| `POST` | `/{id}/cerrar` | ? | Cerrar parte |
| `POST` | `/{id}/anular` | ? | Anular parte |
| `POST` | `/{id}/estado` | ? | Cambiar estado (genérico) |

### Catálogos (`/api/v1/catalog`)

| Método | Endpoint | Auth | Descripción |
|--------|----------|------|-------------|
| `GET` | `/clientes` | ? | Buscar clientes |
| `GET` | `/grupos` | ? | Listar grupos |
| `GET` | `/tipos` | ? | Listar tipos |

### Administración (`/api/v1/admin`)

| Método | Endpoint | Auth | Descripción |
|--------|----------|------|-------------|
| `GET` | `/ping` | ADMIN | Test conexión |
| `GET` | `/users` | ADMIN | Listar usuarios |
| `POST` | `/users` | ADMIN | Crear usuario |
| `PUT` | `/users/{id}/roles` | ADMIN | Modificar roles |
| `PUT` | `/users/{id}/enabled` | ADMIN | Habilitar/deshabilitar |
| `POST` | `/users/{id}/reset-password` | ADMIN | Reset contraseña |

---

## ?? Estructura de Archivos

```
GestionTime.Api/
??? ?? Contracts/           # DTOs
?   ??? ?? Auth/
?   ??? ?? Work/
??? ?? Controllers/         # Endpoints REST
??? ?? Logging/             # Sistema de logging
??? ?? Security/            # JWT/Refresh
??? ?? Startup/             # Inicialización
??? ?? docs/                # Documentación
?   ??? PROJECT_OVERVIEW.md
?   ??? LOGGING.md
?   ??? ESTADOS.md
??? Program.cs
??? appsettings.json

GestionTime.Domain/
??? ?? Auth/
?   ??? User.cs
?   ??? Role.cs
?   ??? UserRole.cs
?   ??? RefreshToken.cs
??? ?? Work/
    ??? ParteDeTrabajo.cs
    ??? EstadoParte.cs      # Constantes de estados
    ??? Cliente.cs
    ??? Grupo.cs
    ??? Tipo.cs

GestionTime.Infrastructure/
??? ?? Persistence/
?   ??? GestionTimeDbContext.cs
??? ?? Migrations/
    ??? ?? SQL/
        ??? 20250117_CambiarEstadoAInteger.sql
```

---

## ?? Ejecución

```bash
# Desarrollo
dotnet run --project GestionTime.Api

# Producción
dotnet publish -c Release
```

---

## ?? Notas de Desarrollo

1. **PostgreSQL 9.4**: Usa `SERIAL` en lugar de `IDENTITY`
2. **Cookies Cross-Origin**: `SameSite=None` y `Secure=true`
3. **Estados numéricos**: Ver [ESTADOS.md](./ESTADOS.md)
4. **Logging separado**: Ver [LOGGING.md](./LOGGING.md)
5. **Multi-tenant**: Cada usuario solo accede a sus propios partes
